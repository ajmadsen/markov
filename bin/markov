#!/usr/bin/env ruby

require 'markov'
require 'commander/import'

config_dir = File.expand_path '~/.markov'
unless Dir.exist? config_dir
  Dir::mkdir config_dir
end

DB = Markov::Database.new "#{config_dir}/markov.db"#, synchronous: :off

program :name, 'Markov'
program :version, '0.0.1'
program :description, 'Program that builds markov chains based on input text and generates strings based on the markov chains.'

command :process do |c|
  c.syntax = 'markov process <chain> <file>'
  c.description = 'Processes input text to generate markov chain.'
  c.action do |args, options|
    File.open(args[1]) do |f|
      Markov::TextProcessor.new(DB, args[0], 3).process(f)
    end
  end
end

command :filter do |c|
  c.syntax = 'markov filter <skype_text>'
  c.description = 'Filters skype text to remove xml junk'
  c.action do |args, options|
    temp = Tempfile.new 'filter'
    File.open(args[0]) do |f|
      f.each_line do |line|
        line.strip!
        line.downcase!
        line.gsub!(/<.*?>/, "")
        line.gsub! "&amp;", "&"
        line.gsub! "&quot;", "\""
        line.gsub! "&apos;", "\'"
        line.gsub! "&gt;", ">"
        line.gsub! "&lt;", "<"
        temp.write line + "\n"
      end
    end
    temp.close
    FileUtils.mv(temp, args[0])
  end
end

